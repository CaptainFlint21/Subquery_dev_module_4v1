{"version":3,"file":"init-controller.test.js","sourceRoot":"","sources":["../../src/controller/init-controller.test.ts"],"names":[],"mappings":"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","sourcesContent":["// Copyright 2020-2021 OnFinality Limited authors & contributors\n// SPDX-License-Identifier: Apache-2.0\n\nimport * as fs from 'fs';\nimport os from 'os';\nimport path from 'path';\nimport {fetchTemplates, cloneProjectGit, cloneProjectTemplate, prepare, readDefaults} from './init-controller';\n\n// async\nconst fileExists = async (file: string): Promise<boolean> => {\n  return new Promise<boolean>((resolve, reject) => {\n    fs.access(file, fs.constants.F_OK, (err) => {\n      err ? reject(err) : resolve(true);\n    });\n  });\n};\n\nasync function makeTempDir() {\n  const sep = path.sep;\n  const tmpDir = os.tmpdir();\n  const tempPath = await fs.promises.mkdtemp(`${tmpDir}${sep}`);\n  return tempPath;\n}\njest.setTimeout(30000);\n\nconst projectSpec = {\n  name: 'mocked_starter',\n  repository: '',\n  endpoint: 'wss://rpc.polkadot.io/public-ws',\n  specVersion: '0.2.0',\n  author: 'jay',\n  description: 'this is test for init controller',\n  version: '',\n  license: '',\n};\n\ndescribe('Cli can create project', () => {\n  it('should resolve when starter project created via template', async () => {\n    const tempPath = await makeTempDir();\n    const templates = await fetchTemplates();\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, templates[0]);\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}`))).resolves.toEqual(true);\n  });\n\n  it('should resolve when starter project created via git', async () => {\n    const tempPath = await makeTempDir();\n    const projectPath = await cloneProjectGit(\n      tempPath,\n      projectSpec.name,\n      'https://github.com/subquery/subql-starter',\n      'v0.2.0'\n    );\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}`))).resolves.toEqual(true);\n  });\n\n  it('throw error if .git exists in starter project', async () => {\n    const tempPath = await makeTempDir();\n    const templates = await fetchTemplates();\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, templates[0]);\n    await prepare(projectPath, projectSpec);\n    await expect(fileExists(path.join(tempPath, `${projectSpec.name}/.git`))).rejects.toThrow();\n  });\n\n  it('prepare correctly applies project details', async () => {\n    const tempPath = await makeTempDir();\n    const templates = await fetchTemplates();\n    const template = templates.find(({name, specVersion}) => name === 'subql-starter' && specVersion === '0.2.0');\n    const projectPath = await cloneProjectTemplate(tempPath, projectSpec.name, template);\n    await prepare(projectPath, projectSpec);\n    const [specVersion, repository, endpoint, author, version, description, license] = await readDefaults(projectPath);\n    expect(projectSpec.specVersion).toEqual(specVersion);\n    expect(projectSpec.repository).toEqual(repository);\n    expect(projectSpec.endpoint).toEqual(endpoint);\n    expect(projectSpec.author).toEqual(author);\n    expect(projectSpec.version).toEqual(version);\n    expect(projectSpec.description).toEqual(description);\n    expect(projectSpec.license).toEqual(license);\n  });\n});\n"]}